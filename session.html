<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Session Details</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .session-header {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .session-subtitle {
      font-size: 1.1rem;
      color: var(--text-light);
      font-style: italic;
      margin-bottom: 24px;
    }

    .session-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .meta-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .meta-label {
      font-size: 0.85rem;
      color: var(--text-light);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .meta-value {
      font-size: 1rem;
      color: var(--text);
      font-weight: 600;
    }

    .session-content {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .content-section {
      margin-bottom: 32px;
    }

    .content-section:last-child {
      margin-bottom: 0;
    }

    .content-section h2 {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 16px;
    }

    .content-section p {
      margin-bottom: 12px;
      color: var(--text);
    }

    .people-list {
      list-style: none;
      padding: 0;
    }

    .people-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .people-list li:last-child {
      border-bottom: none;
    }

    .people-list a {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.2s;
    }

    .questions-list {
      list-style-type: decimal;
      padding-left: 24px;
      color: var(--text);
    }

    .questions-list li {
      margin-bottom: 12px;
      padding-left: 4px;
    }

    .people-list a:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }


    /* Sub-Sessions */
    .sub-sessions-section {
      margin-top: 32px;
    }

    .sub-sessions-section h2 {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 16px;
    }

    .sub-session-item {
      background: var(--white);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .sub-session-item:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transform: translateX(4px);
      border-left-color: var(--primary-light);
    }

    .sub-session-item a {
      color: var(--primary);
      text-decoration: underline;
    }

    .sub-session-item a:hover {
      color: var(--primary-light);
    }

    .sub-session-item-number {
      display: inline-block;
      background: var(--primary);
      color: var(--white);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      margin-right: 12px;
      vertical-align: top;
    }

    .sub-session-item-content {
      display: inline-block;
      width: calc(100% - 50px);
      vertical-align: top;
    }

    .sub-session-item-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .sub-session-item-presenter {
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .sub-session-item-presenter a {
      color: var(--primary);
      text-decoration: none;
    }

    .sub-session-item-presenter a:hover {
      text-decoration: underline;
    }

    .sub-session-item-time {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <a href="index.html" class="back-link">← Back to Schedule</a>
    <div id="sessionContent"></div>
  </div>

  <script src="js/schedule.js"></script>

  <script>
    // Helper function moved to script block but data comes from schedule.js



    // Get session ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('id');

    // Find the session - first check top-level sessions, then sub-sessions
    let session = sessions.find(s => s.id === sessionId);
    let subSession = null;
    let parentSession = null;

    // If not found in top-level, search sub-sessions
    if (!session) {
      for (const s of sessions) {
        if (s.subSessions) {
          subSession = s.subSessions.find(sub => sub.id === sessionId);
          if (subSession) {
            parentSession = s;
            break;
          }
        }
      }
    }

    // Render the page
    const contentDiv = document.getElementById('sessionContent');

    if (!session && !subSession) {
      contentDiv.innerHTML = `
        <div class="error-message">
          <h2>Session Not Found</h2>
          <p>The session you're looking for doesn't exist.</p>
          <p><a href="index.html">Return to schedule</a></p>
        </div>
      `;
      document.title = 'Session Not Found';
    } else {
      // If we have a sub-session, render it with parent context
      if (subSession && parentSession) {
        // Calculate time for sub-session
        let timeHTML = '';
        let subStartTime = '';
        let subEndTime = '';
        const subIndex = parentSession.subSessions.findIndex(sub => sub.id === subSession.id);

        if (parentSession.start && subSession.duration) {
          const durationMatch = subSession.duration.match(/(\d+)/);
          if (durationMatch) {
            const minutes = parseInt(durationMatch[1]);
            const [parentHours, parentMinutes] = parentSession.start.split(':').map(Number);
            let cumulativeMinutes = subIndex * minutes;
            let subStartHours = parentHours + Math.floor((parentMinutes + cumulativeMinutes) / 60);
            let subStartMinutes = (parentMinutes + cumulativeMinutes) % 60;
            let subEndMinutes = subStartMinutes + minutes;
            let subEndHours = subStartHours + Math.floor(subEndMinutes / 60);
            subEndMinutes = subEndMinutes % 60;

            const formatSubTime = (hours, mins) => {
              const ampm = hours >= 12 ? 'PM' : 'AM';
              const h12 = hours % 12 || 12;
              return `${h12}:${String(mins).padStart(2, '0')} ${ampm}`;
            };

            subStartTime = formatSubTime(subStartHours, subStartMinutes);
            subEndTime = formatSubTime(subEndHours, subEndMinutes);
            timeHTML = `${subStartTime} – ${subEndTime} (EST)`;
          }
        } else if (subSession.start && subSession.end) {
          subStartTime = formatTime(subSession.start);
          subEndTime = formatTime(subSession.end);
          timeHTML = `${subStartTime} – ${subEndTime} (EST)`;
        }

        // Generate avatar for presenter
        const presenterAvatar = avatarHTML(subSession.presenter);
        const presenterLink = `<a href="${getSpeakerUrl(subSession.presenter)}">${subSession.presenter}</a>`;

        const parentTypeClass = parentSession.type.toLowerCase().replace(/\s+/g, '-');
        const parentSubcode = SUBCODES[parentSession.id] ? `<span class="subcode">${SUBCODES[parentSession.id]}</span>` : '';

        contentDiv.innerHTML = `
          <div class="session-header">
            <span class="session-badge ${parentTypeClass}">${parentSession.type}${parentSubcode}</span>
            <h1>${subSession.title}</h1>
            <p class="session-subtitle" style="font-size: 1rem; color: var(--text-light); margin-top: 8px;">
              Part of: <a href="session.html?id=${parentSession.id}" style="color: var(--primary); text-decoration: underline;">${parentSession.title}</a>
            </p>
            
            <div class="session-meta">
              <div class="meta-item">
                <span class="meta-label">Date</span>
                <span class="meta-value">${formatFullDate(parentSession.date)}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Time</span>
                <span class="meta-value">${timeHTML}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Room</span>
                <span class="meta-value">${parentSession.room || 'TBD'}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Duration</span>
                <span class="meta-value">${subSession.duration || 'TBD'}</span>
              </div>
            </div>
          </div>

          <div class="session-content">
            ${presenterAvatar ? `<div class="avatars" aria-label="Presenter">${presenterAvatar}</div>` : ''}
            
            <div class="content-section">
              <h2>Presenter</h2>
              <ul class="people-list">
                <li>${presenterLink}</li>
              </ul>
            </div>

            ${subSession.description ? `
              <div class="content-section">
                <h2>Description</h2>
                <p>${subSession.description}</p>
              </div>
            ` : ''}

            ${(subSession.objectives || []).length > 0 ? `
              <div class="content-section">
                <h2>Objectives</h2>
                <ul class="questions-list">
                  ${subSession.objectives.map(o => `<li>${o}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `;

        document.title = `${subSession.title} - Session Details`;
      } else {
        // Regular session rendering
        const typeClass = session.type.toLowerCase().replace(/\s+/g, '-');
        const subcode = SUBCODES[session.id] ? `<span class="subcode">${SUBCODES[session.id]}</span>` : '';

        // Extract people for avatars
        const people = [
          ...(session.moderator ? session.moderator.split(',').map(x => x.trim()).filter(x => x && x !== '—') : []),
          ...(session.speakers || []).filter(x => x && x !== '—')
        ].filter((v, i, a) => a.indexOf(v) === i);

        const avatarsHTML = people.length > 0
          ? `<div class="avatars" aria-label="Speakers and Moderators">${people.map(avatarHTML).join('')}</div>`
          : '';

        const moderatorsList = session.moderator
          ? session.moderator.split(',').map(m => m.trim()).filter(m => m && m !== '—')
            .map(m => `<li><a href="${getSpeakerUrl(m)}">${m}</a></li>`).join('')
          : '';

        const speakersList = session.speakers && session.speakers.length > 0
          ? session.speakers.filter(s => s && s !== '—')
            .map(s => `<li><a href="${getSpeakerUrl(s)}">${s}</a></li>`).join('')
          : '';

        contentDiv.innerHTML = `
          <div class="session-header">
            <span class="session-badge ${typeClass}">${session.type}${subcode}</span>
            <h1>${session.title}</h1>
            ${session.subtitle ? `<p class="session-subtitle">${session.subtitle}</p>` : ''}
            
            ${session.description ? `<div class="session-description" style="margin-bottom: 24px; font-size: 1.05rem; color: var(--text);">${session.description}</div>` : ''}
            
            <div class="session-meta">
              <div class="meta-item">
                <span class="meta-label">Date</span>
                <span class="meta-value">${formatFullDate(session.date)}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Time</span>
                <span class="meta-value">${formatTime(session.start)} – ${formatTime(session.end)} (EST)</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Room</span>
                <span class="meta-value">${session.room || 'TBD'}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Session ID</span>
                <span class="meta-value">${SUBCODES[session.id] || session.id}</span>
              </div>
            </div>
          </div>

          <div class="session-content">
            ${avatarsHTML}
            
            ${session.moderator ? `
              <div class="content-section">
                <h2>Moderator${session.moderator.includes(',') ? 's' : ''}</h2>
                <ul class="people-list">${moderatorsList}</ul>
              </div>
            ` : ''}

            ${session.speakers && session.speakers.length > 0 ? `
              <div class="content-section">
                <h2>Speakers</h2>
                <ul class="people-list">${speakersList}</ul>
              </div>
            ` : ''}

            ${session.note ? `
              <div class="content-section">
                <h2>Additional Information</h2>
                <p><em>${session.note}</em></p>
              </div>
            ` : ''}
          </div>

          ${(session.objectives || []).length > 0 ? `
            <div class="session-content" style="margin-top: 24px;">
              <div class="content-section">
                <h2>Objectives</h2>
                <ul class="questions-list">
                  ${session.objectives.map(o => `<li>${o}</li>`).join('')}
                </ul>
              </div>
            </div>
          ` : ''}

          ${(session.questions || []).length > 0 ? `
            <div class="session-content" style="margin-top: 24px;">
              <div class="content-section">
                <h2>Questions</h2>
                <ul class="questions-list">
                  ${session.questions.map(q => `<li>${q}</li>`).join('')}
                </ul>
              </div>
            </div>
          ` : ''}

          ${(session.resources || []).length > 0 ? `
            <div class="session-content" style="margin-top: 24px;">
              <div class="content-section">
                <h2>Resources / Reading Materials</h2>
                <ul class="people-list">
                  ${session.resources.map(r => `
                    <li><a href="${r.url}" target="_blank" rel="noopener noreferrer">${r.label || r.url}</a></li>
                  `).join('')}
                </ul>
              </div>
            </div>
          ` : ''}

          ${session.subSessions && session.subSessions.length > 0 ? `
            <div class="content-section sub-sessions-section">
              <h2>Sub-Presentations (${session.subSessions.length})</h2>
              ${session.subSessions.map((subSession, index) => {
          // Calculate time slot if parent session has time and duration
          let timeHTML = '';
          if (session.start && subSession.duration) {
            const durationMatch = subSession.duration.match(/(\d+)/);
            if (durationMatch) {
              const minutes = parseInt(durationMatch[1]);
              const [parentHours, parentMinutes] = session.start.split(':').map(Number);
              let cumulativeMinutes = index * minutes;
              let subStartHours = parentHours + Math.floor((parentMinutes + cumulativeMinutes) / 60);
              let subStartMinutes = (parentMinutes + cumulativeMinutes) % 60;
              let subEndMinutes = subStartMinutes + minutes;
              let subEndHours = subStartHours + Math.floor(subEndMinutes / 60);
              subEndMinutes = subEndMinutes % 60;

              const formatSubTime = (hours, mins) => {
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const h12 = hours % 12 || 12;
                return `${h12}:${String(mins).padStart(2, '0')} ${ampm}`;
              };

              timeHTML = `<div class="sub-session-item-time">${formatSubTime(subStartHours, subStartMinutes)} – ${formatSubTime(subEndHours, subEndMinutes)}</div>`;
            }
          } else if (subSession.start && subSession.end) {
            timeHTML = `<div class="sub-session-item-time">${formatTime(subSession.start)} – ${formatTime(subSession.end)}</div>`;
          }

          const presenterLink = SPEAKER_INFO[subSession.presenter]
            ? `<a href="${getSpeakerUrl(subSession.presenter)}">${subSession.presenter}</a>`
            : subSession.presenter;

          return `
                  <a href="session.html?id=${subSession.id}" class="sub-session-item" style="text-decoration: none; color: inherit; display: block;">
                    <span class="sub-session-item-number">${index + 1}</span>
                    <div class="sub-session-item-content">
                      <div class="sub-session-item-title">${subSession.title}</div>
                      <div class="sub-session-item-presenter">
                        <strong>Presenter:</strong> ${presenterLink}
                      </div>
                      ${timeHTML}
                    </div>
                  </a>
                `;
        }).join('')}
            </div>
          ` : ''}
        </div>
      `;

        document.title = `${session.title} - Session Details`;
      }
    }
  </script>
</body>

</html>